<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UK Software Engineering Jobs Analytics</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <div id="map-panel">
        <h2 class="panel-title">Map</h2>
        <div id="map"></div>
        <div id="remote-count">Remote Jobs: {{ remote_count }}</div>
      </div>

      <div id="list-panel">
        <h2 class="panel-title">List</h2>
        <table id="job-table">
          <thead>
            <tr>
              <th onclick="sortTable(0)">Title</th>
              <th onclick="sortTable(1)">Company</th>
              <th onclick="sortTable(2)">Salary</th>
              <th onclick="sortTable(3)">Post Date</th>
            </tr>
          </thead>
          <tbody>
            {% for job in job_data %}
            <tr>
              <td>{{ job.title }}</td>
              <td>{{ job.company }}</td>
              <td>{{ job.salary }}</td>
              <td>{{ job.post_date }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div id="trend-panel">
        <div id="field-chart">
          <h2 class="panel-title">Trend - Fields</h2>
        </div>
        <div id="tech-chart">
          <h2 class="panel-title">Trend - Technologies</h2>
        </div>
      </div>
    </div>

    <script>
      // Update Plotly theme to match dark theme
      const darkLayout = {
        paper_bgcolor: "#2d2d2d",
        plot_bgcolor: "#2d2d2d",
        font: {
          color: "#e0e0e0",
        },
      };

      // Initialize the map
      const mapData = JSON.parse("{{ map_data | safe }}");
      mapData.layout = { ...mapData.layout, ...darkLayout };
      Plotly.newPlot("map", mapData.data, mapData.layout);

      // Initialize the trend charts
      const fieldData = JSON.parse("{{ field_data | safe }}");
      const techData = JSON.parse("{{ tech_data | safe }}");

      fieldData.layout = { ...fieldData.layout, ...darkLayout };
      techData.layout = { ...techData.layout, ...darkLayout };

      Plotly.newPlot("field-chart", fieldData.data, fieldData.layout);
      Plotly.newPlot("tech-chart", techData.data, techData.layout);

      // Sorting function for the table
      function sortTable(n) {
        const table = document.getElementById("job-table");
        let rows,
          switching = true;
        let i,
          shouldSwitch,
          dir = "asc";
        let switchcount = 0;

        while (switching) {
          switching = false;
          rows = table.rows;

          for (i = 1; i < rows.length - 1; i++) {
            shouldSwitch = false;
            const x = rows[i].getElementsByTagName("TD")[n];
            const y = rows[i + 1].getElementsByTagName("TD")[n];

            if (dir === "asc") {
              if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                shouldSwitch = true;
                break;
              }
            } else if (dir === "desc") {
              if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                shouldSwitch = true;
                break;
              }
            }
          }

          if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchcount++;
          } else if (switchcount === 0 && dir === "asc") {
            dir = "desc";
            switching = true;
          }
        }
      }
    </script>
  </body>
</html>
